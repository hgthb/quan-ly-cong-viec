<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ti·∫øn ƒê·ªô - Version 18.0 (Auto Alert)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #4361ee; --success: #2ecc71; --danger: #ef476f; --warning: #ffd166; --dark: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 5px 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; }
        .container { max-width: 1450px; margin: auto; width: 100%; display: flex; flex-direction: column; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 5px; flex-shrink: 0; }
        .brand { font-size: 16px; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .stats-mini { display: flex; gap: 20px; font-size: 13px; font-weight: 600; }
        .stats-mini span b { color: var(--primary); font-size: 15px; }
        #adminForm { display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 0.4fr 1.2fr 1fr 0.6fr; gap: 5px; background: #fff; padding: 8px; border-radius: 8px; margin-bottom: 5px; flex-shrink: 0; align-items: center; display: none; }
        body.is-admin #adminForm { display: grid; }
        input { height: 30px; padding: 0 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; }
        .btn-add { height: 30px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; }
        .main-content { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; height: 32px; text-transform: uppercase; border-bottom: 1px solid #eee; text-align: left; padding: 0 10px; }
        td { border-bottom: 1px solid #f8fafc; font-size: 12px; height: 38px; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .overdue-row { background-color: #fff1f2 !important; }
        .progress-bg { width: 100%; background: #eee; height: 5px; border-radius: 3px; margin-top: 4px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: 0.3s; }
        .badge { padding: 3px 7px; border-radius: 4px; font-size: 10px; color: #fff; font-weight: 700; }
        .btn-sm { width: 26px; height: 26px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 3px; display: inline-flex; align-items: center; justify-content: center; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 10px 0; background: var(--bg); flex-shrink: 0; }
        .btn-p { padding: 5px 15px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .btn-login { background: #334155; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body class="is-client">

<div class="container">
    <div class="top-bar">
        <div class="brand">üìã QU·∫¢N L√ù TI·∫æN ƒê·ªò <span id="syncText" style="font-size: 10px; color: #999; font-weight: normal;"></span></div>
        <div class="stats-mini">
            <span>T·ªîNG: <b id="statTotal">0</b></span>
            <span>XONG: <b id="statDone">0</b></span>
        </div>
        <div class="auth-btns">
            <button id="btnLogin" class="btn-login" onclick="loginAdmin()">Admin</button>
            <button id="btnLogout" class="btn-login" style="background:var(--danger); display:none" onclick="logoutAdmin()">Tho√°t</button>
        </div>
    </div>

    <div id="adminForm">
        <input type="text" id="taskName" placeholder="T√™n vi·ªác...">
        <input type="date" id="startDate">
        <input type="date" id="deadline">
        <input type="number" id="iterCount" value="1">
        <input type="text" id="taskRef" placeholder="Tham chi·∫øu...">
        <input type="text" id="emailRecipient" placeholder="Email nh·∫≠n nh·∫Øc nh·ªü...">
        <button class="btn-add" onclick="addTask()">TH√äM</button>
    </div>

    <div class="main-content">
        <table>
            <thead>
                <tr>
                    <th style="width: 28%;">Vi·ªác / Email nh·∫≠n</th>
                    <th style="width: 9%;">B·∫Øt ƒë·∫ßu</th>
                    <th style="width: 9%;">H·∫°n ch√≥t</th>
                    <th style="width: 5%; text-align:center">L·∫ßn</th>
                    <th style="width: 11%;">Tham chi·∫øu</th>
                    <th style="width: 14%;">Ti·∫øn ƒë·ªô</th>
                    <th style="width: 10%;">Tr·∫°ng th√°i</th>
                    <th style="width: 12%;">Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>
    </div>

    <div class="pagination">
        <button class="btn-p" id="btnPrev" onclick="changePage(-1)">Tr∆∞·ªõc</button>
        <span id="pageInfo" style="font-size:12px; font-weight:700">Trang 1/1</span>
        <button class="btn-p" id="btnNext" onclick="changePage(1)">Sau</button>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH C·ª¶A B·∫†N ---
    const EMAILJS_PUBLIC_KEY = 'K29qboR4uZpsyMu0Z';
    const EMAILJS_SERVICE_ID = 'service_s73hjtp'; 
    const EMAILJS_TEMPLATE_ID = 'template_0cgys98';

    const BIN_ID = '6965ac34d0ea881f4067e559'; 
    const READ_KEY = '$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K';
    const URL = "https://api.jsonbin.io/v3/b/" + BIN_ID;

    emailjs.init(EMAILJS_PUBLIC_KEY);

    let allTasks = [];
    let MASTER_KEY = localStorage.getItem('my_task_admin_key');
    let currentPage = 1;
    const PAGE_SIZE = 9;

    async function fetchData() {
        checkPermissions();
        try {
            const res = await fetch(URL, { headers: { 'X-Access-Key': READ_KEY, 'X-Bin-Meta': false } });
            const data = await res.json();
            allTasks = data.tasks || (Array.isArray(data) ? data : []);
            renderTable();
            // Sau khi t·∫£i xong d·ªØ li·ªáu, th·ª±c hi·ªán qu√©t qu√° h·∫°n t·ª± ƒë·ªông
            autoCheckOverdue();
        } catch (e) { renderTable(); }
    }

    function renderTable() {
        const body = document.getElementById('taskBody');
        body.innerHTML = '';
        const now = new Date();
        now.setHours(0,0,0,0);

        document.getElementById('statTotal').innerText = allTasks.length;
        document.getElementById('statDone').innerText = allTasks.filter(t => t.status === 'Ho√†n th√†nh').length;

        const sorted = [...allTasks].reverse();
        const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
        if (currentPage > totalPages) currentPage = totalPages;

        const startIdx = (currentPage - 1) * PAGE_SIZE;
        const pageData = sorted.slice(startIdx, startIdx + PAGE_SIZE);

        pageData.forEach(t => {
            const s = new Date(t.start), e = new Date(t.end);
            const isOverdue = e < now && t.status !== "Ho√†n th√†nh";
            let p = (e > s) ? (now - s) / (e - s) : 0;
            p = Math.max(0, Math.min(1, (t.status === "Ho√†n th√†nh" ? 1 : p)));
            
            body.innerHTML += `
                <tr class="${isOverdue ? 'overdue-row' : ''}">
                    <td><b>${t.name}</b><br><small style="color:#999">${t.dept || ''}</small></td>
                    <td>${t.start || ''}</td>
                    <td style="color: ${isOverdue ? 'var(--danger)' : 'inherit'}; font-weight: ${isOverdue ? 'bold' : 'normal'}">${t.end || ''}</td>
                    <td style="text-align:center"><b>${t.iteration || 1}</b></td>
                    <td style="color:#4361ee; font-weight:600">${t.ref || ''}</td>
                    <td>
                        <div style="font-size:9px; font-weight:bold">${Math.round(p*100)}%</div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${p*100}%; background:${p>=1?'#2ecc71':'#4361ee'}"></div></div>
                    </td>
                    <td><span class="badge" style="background:${t.status==='Ho√†n th√†nh'?'#2ecc71':'#4361ee'}">${t.status}</span></td>
                    <td>
                        <button class="btn-sm" style="background:#2ecc71" onclick="updateStatus('${t.id}')"><i class="fa-solid fa-check"></i></button>
                        ${isOverdue ? `<button class="btn-sm" style="background:${t.alertSent ? '#94a3b8' : 'var(--warning)'}; color:#000" onclick="sendEmailManual('${t.id}')" title="${t.alertSent ? 'ƒê√£ g·ª≠i t·ª± ƒë·ªông' : 'G·ª≠i nh·∫Øc nh·ªü'}"><i class="fa-solid fa-envelope"></i></button>` : ''}
                        <button class="btn-sm" style="background:#ef476f" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });

        document.getElementById('pageInfo').innerText = `Trang ${currentPage}/${totalPages}`;
        document.getElementById('btnPrev').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage === totalPages;
    }

    // --- LOGIC T·ª∞ ƒê·ªòNG G·ª¨I (DUY NH·∫§T 1 L·∫¶N) ---
    async function autoCheckOverdue() {
        if (!MASTER_KEY) return;
        const now = new Date();
        now.setHours(0,0,0,0);
        let hasChange = false;

        for (let t of allTasks) {
            const deadline = new Date(t.end);
            if (deadline < now && t.status !== 'Ho√†n th√†nh' && t.dept && !t.alertSent) {
                try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                        task_name: t.name, deadline: t.end, ref: t.ref, dept: t.dept
                    });
                    t.alertSent = true; 
                    hasChange = true;
                    console.log("Auto-sent email for: " + t.name);
                } catch (err) { console.error("Email failed", err); }
            }
        }
        if (hasChange) saveData();
    }

    function sendEmailManual(id) {
        const t = allTasks.find(x => x.id === id);
        if(!t.dept || !confirm(`G·ª≠i nh·∫Øc nh·ªü ƒë·∫øn ${t.dept}?`)) return;
        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
            task_name: t.name, deadline: t.end, ref: t.ref, dept: t.dept
        }).then(() => {
            alert("ƒê√£ g·ª≠i th√†nh c√¥ng!");
            t.alertSent = true;
            saveData();
        });
    }

    async function saveData() {
        if (!MASTER_KEY) return;
        document.getElementById('syncText').innerText = "‚Ä¢ ƒêang ƒë·ªìng b·ªô...";
        try {
            await fetch(URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                body: JSON.stringify({ tasks: allTasks })
            });
            document.getElementById('syncText').innerText = "";
            renderTable();
        } catch (e) { alert("L·ªói l∆∞u d·ªØ li·ªáu"); }
    }

    function addTask() {
        const n = document.getElementById('taskName').value, s = document.getElementById('startDate').value, e = document.getElementById('deadline').value;
        if(!n || !s || !e) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
        allTasks.push({ 
            id: Date.now().toString(), name: n, dept: document.getElementById('emailRecipient').value, 
            start: s, end: e, iteration: document.getElementById('iterCount').value || 1, 
            ref: document.getElementById('taskRef').value || "", status: "ƒêang l√†m", alertSent: false 
        });
        saveData();
        document.getElementById('taskName').value = ''; document.getElementById('taskRef').value = ''; document.getElementById('emailRecipient').value = '';
    }

    function updateStatus(id) { const t = allTasks.find(x => x.id === id); if(t && MASTER_KEY) { t.status = t.status === "Ho√†n th√†nh" ? "ƒêang l√†m" : "Ho√†n th√†nh"; saveData(); } }
    function deleteTask(id) { if(MASTER_KEY && confirm("X√≥a?")) { allTasks = allTasks.filter(x => x.id !== id); saveData(); } }
    function checkPermissions() { const isAdm = !!MASTER_KEY; document.body.className = isAdm ? 'is-admin' : 'is-client'; document.getElementById('btnLogout').style.display = isAdm ? 'block' : 'none'; document.getElementById('btnLogin').style.display = isAdm ? 'none' : 'block'; }
    function loginAdmin() { const k = prompt("Master Key:"); if(k) { MASTER_KEY = k; localStorage.setItem('my_task_admin_key', k); fetchData(); } }
    function logoutAdmin() { localStorage.removeItem('my_task_admin_key'); location.reload(); }
    function changePage(v) { currentPage += v; renderTable(); }

    window.onload = fetchData;
</script>
</body>
</html>
