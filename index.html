<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Tiến Độ - Version 13.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #4361ee; --success: #2ecc71; --danger: #ef476f; 
            --warning: #ffd166; --dark: #1e293b; --bg: #f1f5f9;
        }
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 5px 10px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box;
        }
        .container { max-width: 1450px; margin: auto; width: 100%; display: flex; flex-direction: column; height: 100%; }

        /* TOP BAR */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 5px 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 5px; flex-shrink: 0;
        }
        .brand { font-size: 16px; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 5px; }
        .stats-mini { display: flex; gap: 20px; font-size: 13px; font-weight: 600; }
        .stats-mini span b { color: var(--primary); font-size: 15px; }

        /* ADMIN FORM */
        #adminForm { 
            display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr 0.5fr 1.2fr 0.8fr; gap: 5px; 
            background: #fff; padding: 5px; border-radius: 8px; margin-bottom: 5px; flex-shrink: 0; align-items: center;
            display: none;
        }
        body.is-admin #adminForm { display: grid; }
        input { height: 28px; padding: 0 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; }
        .btn-add { height: 28px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; }

        /* TABLE */
        .main-content { 
            background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; 
        }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; height: 30px; text-transform: uppercase; border-bottom: 1px solid #eee; text-align: left; padding: 0 10px; }
        td { border-bottom: 1px solid #f8fafc; font-size: 12px; height: 36px; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .col-task { width: 35%; } .col-date { width: 9%; } .col-iter { width: 5%; text-align: center; }
        .col-ref { width: 11%; } .col-prog { width: 13%; } .col-status { width: 9%; } .col-act { width: 9%; }

        .progress-bg { width: 100%; background: #eee; height: 4px; border-radius: 2px; margin-top: 3px; }
        .progress-fill { height: 100%; border-radius: 2px; transition: 0.3s; }
        .badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; color: #fff; font-weight: 700; }
        .btn-sm { width: 24px; height: 24px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 2px; }
        .btn-iter { background: var(--warning); color: #000; width: 16px; height: 16px; font-size: 8px; padding: 0; }

        /* PAGINATION */
        .pagination { 
            display: flex; justify-content: center; align-items: center; gap: 15px; 
            padding: 8px 0; background: var(--bg); flex-shrink: 0;
        }
        .btn-p { padding: 4px 12px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .btn-p:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-login { background: #334155; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body class="is-client">

<div class="container">
    <div class="top-bar">
        <div class="brand"><i class="fa-solid fa-list-check"></i> QUẢN LÝ TIẾN ĐỘ <span id="syncStatus" style="font-size: 10px; color: #999; margin-left: 10px;"></span></div>
        <div class="stats-mini">
            <span>TỔNG: <b id="statTotal">0</b></span>
            <span>XONG: <b id="statDone">0</b></span>
        </div>
        <div class="auth-btns">
            <button id="btnLogin" class="btn-login" onclick="loginAdmin()">Admin</button>
            <button id="btnLogout" class="btn-login" style="background:var(--danger); display:none" onclick="logoutAdmin()">Thoát</button>
        </div>
    </div>

    <div id="adminForm">
        <input type="text" id="taskName" placeholder="Tên việc...">
        <input type="text" id="dept" placeholder="Phòng ban...">
        <input type="date" id="startDate">
        <input type="date" id="deadline">
        <input type="number" id="iterCount" value="1" title="Lần">
        <input type="text" id="taskRef" maxlength="12" placeholder="Tham chiếu...">
        <button class="btn-add" onclick="addTask()">THÊM</button>
    </div>

    <div class="main-content">
        <table>
            <thead>
                <tr>
                    <th class="col-task">Việc / Phòng</th>
                    <th class="col-date">Bắt đầu</th>
                    <th class="col-date">Hạn chót</th>
                    <th class="col-iter">Lần</th>
                    <th class="col-ref">Tham chiếu</th>
                    <th class="col-prog">Tiến độ</th>
                    <th class="col-status">Trạng thái</th>
                    <th class="col-act">Thao tác</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>
    </div>

    <div class="pagination">
        <button class="btn-p" id="btnPrev" onclick="changePage(-1)"><i class="fa-solid fa-arrow-left"></i> Trước</button>
        <span id="pageInfo" style="font-size:12px; font-weight:700">Trang 1/1</span>
        <button class="btn-p" id="btnNext" onclick="changePage(1)">Sau <i class="fa-solid fa-arrow-right"></i></button>
    </div>
</div>

<script>
    // --- CẤU HÌNH ---
    const BIN_ID = '6965ac34d0ea881f4067e559'; 
    const MASTER_KEY_API = '$2a$10$zN5MZaAsLugTkyNZA0ZHMu7CKiAktxDFCw1IGFEi4H46JOocrLTSy'; // Master Key của JSONBin.io để ghi dữ liệu
    const ACCESS_KEY = '$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K'; // Access Key để đọc dữ liệu

    const URL = "https://api.jsonbin.io/v3/b/" + BIN_ID;

    let allTasks = [];
    let IS_ADMIN_LOGGED_IN = localStorage.getItem('is_admin') === 'true';
    let currentPage = 1;
    const PAGE_SIZE = 9;

    async function fetchData() {
        checkPermissions();
        showStatus("Đang tải...");
        try {
            const res = await fetch(URL, { 
                method: 'GET',
                headers: { 'X-Access-Key': ACCESS_KEY, 'X-Bin-Meta': false } 
            });
            const data = await res.json();
            // Xử lý nếu data là object { tasks: [] } hoặc mảng trực tiếp
            allTasks = data.tasks || (Array.isArray(data) ? data : []);
            showStatus("Đã đồng bộ");
            renderTable();
        } catch (e) { 
            showStatus("Lỗi kết nối");
            console.error(e);
            renderTable(); 
        }
    }

    async function saveData() {
        if(!IS_ADMIN_LOGGED_IN) return;
        showStatus("Đang lưu...");
        try {
            const res = await fetch(URL, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-Master-Key': MASTER_KEY_API 
                },
                body: JSON.stringify({ tasks: allTasks })
            });
            if(res.ok) {
                showStatus("Đã lưu lên JSONBin");
                renderTable();
            } else {
                showStatus("Lỗi lưu (Check Key)");
            }
        } catch (e) { 
            showStatus("Lỗi mạng");
        }
    }

    function renderTable() {
        const body = document.getElementById('taskBody');
        body.innerHTML = '';
        const now = new Date();

        // Thống kê
        document.getElementById('statTotal').innerText = allTasks.length;
        document.getElementById('statDone').innerText = allTasks.filter(t => t.status === 'Hoàn thành').length;

        const sorted = [...allTasks].reverse();
        const totalPages = Math.ceil(sorted.length / PAGE_SIZE) || 1;
        if (currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * PAGE_SIZE;
        const pageData = sorted.slice(start, start + PAGE_SIZE);

        pageData.forEach(t => {
            const s = new Date(t.start), e = new Date(t.end);
            let p = (e > s) ? (now - s) / (e - s) : 0;
            p = Math.max(0, Math.min(1, (t.status === "Hoàn thành" ? 1 : p)));
            
            body.innerHTML += `
                <tr>
                    <td title="${t.name}"><b>${t.name}</b><br><small style="color:#999">${t.dept || ''}</small></td>
                    <td>${t.start || ''}</td>
                    <td>${t.end || ''}</td>
                    <td style="text-align:center">
                        ${t.iteration || 1}
                        ${IS_ADMIN_LOGGED_IN ? `<button class="btn-sm btn-iter" onclick="incIter('${t.id}')">▲</button>` : ''}
                    </td>
                    <td style="color:#4361ee; font-weight:600">${t.ref || ''}</td>
                    <td>
                        <div style="font-size:9px; font-weight:bold">${Math.round(p*100)}%</div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${p*100}%; background:${p>=1?'#2ecc71':'#4361ee'}"></div></div>
                    </td>
                    <td><span class="badge" style="background:${t.status==='Hoàn thành'?'#2ecc71':'#4361ee'}">${t.status}</span></td>
                    <td>
                        <button class="btn-sm" style="background:#2ecc71" onclick="updateStatus('${t.id}')"><i class="fa-solid fa-check"></i></button>
                        <button class="btn-sm" style="background:#ef476f" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });

        for (let i = pageData.length; i < PAGE_SIZE; i++) {
            body.innerHTML += `<tr style="height:36px"><td colspan="8">&nbsp;</td></tr>`;
        }

        document.getElementById('pageInfo').innerText = `Trang ${currentPage}/${totalPages}`;
        document.getElementById('btnPrev').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage === totalPages;
    }

    // --- LOGIC ---
    function showStatus(txt) { document.getElementById('syncStatus').innerText = "• " + txt; }

    function checkPermissions() {
        document.body.className = IS_ADMIN_LOGGED_IN ? 'is-admin' : 'is-client';
        document.getElementById('btnLogout').style.display = IS_ADMIN_LOGGED_IN ? 'block' : 'none';
        document.getElementById('btnLogin').style.display = IS_ADMIN_LOGGED_IN ? 'none' : 'block';
    }

    function loginAdmin() {
        const pass = prompt("Nhập mã bảo mật Admin:");
        if(pass === "1234") { // Bạn có thể đổi mã này
            IS_ADMIN_LOGGED_IN = true;
            localStorage.setItem('is_admin', 'true');
            fetchData();
        } else {
            alert("Sai mã!");
        }
    }

    function logoutAdmin() {
        IS_ADMIN_LOGGED_IN = false;
        localStorage.removeItem('is_admin');
        location.reload();
    }

    function addTask() {
        const n = document.getElementById('taskName').value, s = document.getElementById('startDate').value, e = document.getElementById('deadline').value;
        if(!n || !s || !e) return alert("Vui lòng điền đủ thông tin!");
        
        allTasks.push({ 
            id: Date.now().toString(), 
            name: n, 
            dept: document.getElementById('dept').value || "VP", 
            start: s, 
            end: e, 
            iteration: parseInt(document.getElementById('iterCount').value) || 1, 
            ref: document.getElementById('taskRef').value || "",
            status: "Đang làm" 
        });
        saveData();
        document.getElementById('taskName').value = '';
        document.getElementById('taskRef').value = '';
    }

    function incIter(id) { const t = allTasks.find(x => x.id === id); if(t) { t.iteration = (t.iteration || 1) + 1; saveData(); } }
    function updateStatus(id) { if(!IS_ADMIN_LOGGED_IN) return alert("Cần quyền Admin"); const t = allTasks.find(x => x.id === id); if(t) { t.status = t.status === "Hoàn thành" ? "Đang làm" : "Hoàn thành"; saveData(); } }
    function deleteTask(id) { if(!IS_ADMIN_LOGGED_IN || !confirm("Xóa?")) return; allTasks = allTasks.filter(x => x.id !== id); saveData(); }
    function changePage(v) { currentPage += v; renderTable(); }

    window.onload = fetchData;
</script>
</body>
</html>
