<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Công Việc</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #4361ee; --success: #2ecc71; --danger: #ef476f; 
            --warning: #ffd166; --dark: #2b2d42; --bg: #f8f9fc;
            --text-main: #4a5568; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body { font-family: 'Inter', -apple-system, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1250px; margin: auto; }

        /* Header & Admin Controls */
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-section h2 { color: var(--dark); margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        .admin-controls { display: flex; align-items: center; gap: 10px; }
        .admin-badge { background: var(--success); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; display: none; }
        .btn-auth { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        #btnLogin { background: var(--dark); color: white; }
        #btnLogout { background: var(--danger); color: white; display: none; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 28px; font-weight: 800; color: var(--dark); margin-top: 5px; }

        /* Admin Form (Mặc định ẩn) */
        #adminForm { 
            background: white; padding: 25px; border-radius: 15px; box-shadow: var(--shadow); 
            display: none; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; 
        }
        .input-box { display: flex; flex-direction: column; gap: 5px; }
        .input-box label { font-size: 12px; font-weight: 600; color: #718096; }
        input { padding: 12px; border: 1.5px solid #edf2f7; border-radius: 8px; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; align-self: flex-end; }

        /* Table Style */
        .card-table { background: white; border-radius: 15px; box-shadow: var(--shadow); overflow: hidden; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; table-layout: fixed; }
        th { background: #f1f5f9; color: #475569; padding: 18px; text-align: left; font-size: 13px; font-weight: 700; text-transform: uppercase; }
        td { padding: 18px; border-bottom: 1px solid #edf2f7; vertical-align: middle; font-size: 14px; }
        tr:hover td { background-color: #f8fafc; }

        /* Cột độ rộng */
        .col-task { width: 22%; } .col-start { width: 13%; } .col-end { width: 13%; }
        .col-progress { width: 18%; } .col-status { width: 14%; } .col-action { width: 15%; }

        /* Progress & Badges */
        .progress-bar { width: 100%; background: #e2e8f0; border-radius: 10px; height: 8px; margin-top: 8px; }
        .progress-fill { height: 100%; border-radius: 10px; transition: 0.8s width ease-in-out; }
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; color: white; display: inline-block; }
        .bg-new { background: var(--primary); } .bg-done { background: var(--success); }
        .bg-urgent { background: #f59e0b; } .bg-overdue { background: var(--danger); }

        /* Action Buttons */
        .btn-group { display: flex; gap: 8px; }
        .btn-icon { width: 35px; height: 35px; border-radius: 8px; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-done { background: var(--success); } .btn-delete { background: #fee2e2; color: var(--danger); }

        /* Loader */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; font-size: 18px; font-weight: 600; color: var(--dark); }
    </style>
</head>
<body>

<div id="loader"><i class="fa-solid fa-spinner fa-spin"></i> &nbsp; Đang xử lý dữ liệu...</div>

<div class="container">
    <div class="header-section">
        <h2><i class="fa-solid fa-clipboard-list"></i> QUẢN LÝ TIẾN ĐỘ</h2>
        <div class="admin-controls">
            <span id="adminBadge" class="admin-badge"><i class="fa-solid fa-user-shield"></i> ADMIN</span>
            <button id="btnLogin" class="btn-auth" onclick="loginAdmin()"><i class="fa-solid fa-key"></i> Đăng nhập Admin</button>
            <button id="btnLogout" class="btn-auth" onclick="logoutAdmin()"><i class="fa-solid fa-sign-out"></i> Thoát</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="border-left-color: var(--primary)"><h3>Tổng công việc</h3><div id="statTotal" class="value">0</div></div>
        <div class="stat-card" style="border-left-color: var(--warning)"><h3>Đang thực hiện</h3><div id="statDoing" class="value">0</div></div>
        <div class="stat-card" style="border-left-color: var(--success)"><h3>Đã hoàn thành</h3><div id="statDone" class="value">0</div></div>
    </div>

    <div id="adminForm">
        <div class="input-box"><label>Tên công việc</label><input type="text" id="taskName" placeholder="..."></div>
        <div class="input-box"><label>Phòng ban</label><input type="text" id="dept" placeholder="..."></div>
        <div class="input-box"><label>Ngày bắt đầu</label><input type="date" id="startDate"></div>
        <div class="input-box"><label>Hạn hoàn thành</label><input type="date" id="deadline"></div>
        <button class="btn-add" onclick="addTask()"><i class="fa-solid fa-plus"></i> THÊM MỚI</button>
    </div>

    <div class="card-table">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th class="col-task">Công việc / Phòng</th>
                        <th class="col-start">Bắt đầu</th>
                        <th class="col-end">Hạn chót</th>
                        <th class="col-progress">Tiến độ</th>
                        <th class="col-status">Trạng thái</th>
                        <th class="col-action admin-only-ui" style="display:none">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="taskBody">
                    <tr><td colspan="6" style="text-align:center; padding: 50px;">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. CẤU HÌNH THÔNG SỐ (BẮT BUỘC THAY ĐỔI)
    // ==========================================
    const BIN_ID = '6965ac34d0ea881f4067e559'; 
    const READ_KEY = '$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K';
    
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
    let allTasks = [];
    let MASTER_KEY = localStorage.getItem('my_task_admin_key');

    // ==========================================
    // 2. GIAO TIẾP VỚI JSONBIN
    // ==========================================
    async function fetchData() {
        showLoading(true);
        const keyToUse = MASTER_KEY ? MASTER_KEY : READ_KEY;
        try {
            const res = await fetch(URL, {
                method: 'GET',
                headers: { 'X-Access-Key': keyToUse, 'X-Bin-Meta': false }
            });
            if (!res.ok) throw new Error("Key không hợp lệ hoặc lỗi kết nối");
            const data = await res.json();
            // Đọc đúng cấu trúc {"tasks": []}
            allTasks = (data && data.tasks) ? data.tasks : [];
            checkPermissions();
            renderTable();
        } catch (err) {
            alert("Lỗi tải dữ liệu: " + err.message);
        }
        showLoading(false);
    }

    async function saveData() {
        if (!MASTER_KEY) return;
        showLoading(true);
        try {
            await fetch(URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                body: JSON.stringify({ "tasks": allTasks })
            });
            renderTable();
        } catch (err) {
            alert("Lưu thất bại: " + err.message);
        }
        showLoading(false);
    }

    // ==========================================
    // 3. QUẢN LÝ QUYỀN TRUY CẬP
    // ==========================================
    function loginAdmin() {
        const key = prompt("Nhập MASTER KEY để mở quyền chỉnh sửa:");
        if (key) {
            MASTER_KEY = key;
            localStorage.setItem('my_task_admin_key', key);
            fetchData();
        }
    }

    function logoutAdmin() {
        localStorage.removeItem('my_task_admin_key');
        MASTER_KEY = null;
        location.reload();
    }

    function checkPermissions() {
        const isAdm = !!MASTER_KEY;
        document.getElementById('adminForm').style.display = isAdm ? 'grid' : 'none';
        document.getElementById('adminBadge').style.display = isAdm ? 'inline-block' : 'none';
        document.getElementById('btnLogout').style.display = isAdm ? 'inline-block' : 'none';
        document.getElementById('btnLogin').style.display = isAdm ? 'none' : 'flex';
        
        const adminUI = document.querySelectorAll('.admin-only-ui');
        adminUI.forEach(el => el.style.display = isAdm ? 'table-cell' : 'none');
    }

    // ==========================================
    // 4. XỬ LÝ DỮ LIỆU & HIỂN THỊ
    // ==========================================
    function renderTable() {
        const body = document.getElementById('taskBody');
        body.innerHTML = '';
        const now = new Date();

        // Cập nhật thống kê
        document.getElementById('statTotal').innerText = allTasks.length;
        document.getElementById('statDone').innerText = allTasks.filter(t => t.status === 'Hoàn thành').length;
        document.getElementById('statDoing').innerText = allTasks.filter(t => t.status !== 'Hoàn thành').length;

        if (allTasks.length === 0) {
            body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px">Chưa có dữ liệu công việc.</td></tr>';
            return;
        }

        [...allTasks].reverse().forEach(task => {
            const dStart = new Date(task.start);
            const dEnd = new Date(task.end);
            let percent = (dEnd > dStart) ? (now - dStart) / (dEnd - dStart) : 0;
            percent = Math.max(0, Math.min(1, percent));

            let badge = "bg-new"; let txt = "Đang chạy";
            if (task.status === "Hoàn thành") { badge = "bg-done"; txt = "Hoàn thành"; percent = 1; }
            else if (now > dEnd) { badge = "bg-overdue"; txt = "Quá hạn"; }
            else if (percent > 0.8) { badge = "bg-urgent"; txt = "Sắp đến hạn"; }

            let actionHtml = MASTER_KEY ? `
                <td class="admin-only-ui">
                    <div class="btn-group">
                        <button class="btn-icon btn-done" onclick="updateStatus('${task.id}', '${task.status}')"><i class="fa-solid ${task.status === 'Hoàn thành' ? 'fa-rotate-left' : 'fa-check'}"></i></button>
                        <button class="btn-